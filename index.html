<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–£—á–µ–±–Ω–∞—è –ì–µ–π–º–∏—Ñ–∏–∫–∞—Ü–∏—è</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-auth-compat.js"></script>

  <style>
    body { font-family: sans-serif; max-width: 700px; margin: 40px auto; padding: 0 10px; }
    h1 { text-align: center; }
    form { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 20px; }
    select, input, button { padding: 6px 8px; font-size: 16px; }
    button { cursor: pointer; }
    .history { margin-top: 20px; }
    .entry { border-bottom: 1px solid #ccc; padding: 8px 0; display: flex; justify-content: space-between; align-items: center;}
    .bonus { color: green; font-weight: bold; }
    .negative { color: red; }
    .delete-btn { background: none; border: none; color: red; font-size: 18px; cursor: pointer; }

    .cashout-area { display:flex; gap:8px; align-items:center; justify-content:center; margin: 20px 0;}
    .cashout-btn { padding:10px 20px; font-size:18px; background:#4caf50; color:white; border:none; border-radius:5px; }
    .cashout-input { width:120px; font-size:16px; padding:6px; }

    .sidebar {
      position: fixed; top: 0; left: 0; transform: translateX(-100%);
      width: 280px; height: 100%; background: #333; color: #fff;
      padding: 16px; box-sizing: border-box; transition: transform 0.3s ease;
      z-index: 1000; overflow-y: auto;
    }
    .sidebar.open { transform: translateX(0); }
    .sidebar h2 { color:#fff; font-size:18px; margin: 0 0 16px 0; }

    .panel-btn {
      display:block; width:100%; margin-bottom:10px; padding:10px 14px; font-size:16px;
      background:none; color: #fff; border:1px solid rgba(255,255,255,0.3);
      border-radius:6px; text-align:left; box-sizing:border-box;
    }
    .panel-btn:hover { background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.5); }
    .file-input { display:none; }

    .burger {
      position: fixed; top:20px; left:20px;
      font-size:26px; background:none; border:none; color:#333; cursor:pointer; z-index:1100;
    }
    .close-btn {
      position:absolute; top:10px; right:10px;
      background:none; border:none; color:white; font-size:24px; cursor:pointer;
    }

    .auth { display:flex; gap:8px; align-items:center; margin-bottom:16px; flex-wrap:wrap; }
    .muted { color:#666; font-size:14px; margin-top:-8px; margin-bottom:12px; }
  </style>
</head>
<body>
  <button class="burger" id="burgerBtn">‚ò∞</button>
  <div id="root"></div>

  <div id="sidebar" class="sidebar">
    <button class="close-btn" id="closeSidebar" title="–ó–∞–∫—Ä—ã—Ç—å">‚úñ</button>
    <h2>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ</h2>
    <button class="panel-btn" id="exportBtn">‚¨áÔ∏è –≠–∫—Å–ø–æ—Ä—Ç CSV</button>
    <label class="panel-btn" for="importFile">üì§ –ò–º–ø–æ—Ä—Ç CSV</label>
    <input type="file" accept=".csv" id="importFile" class="file-input">
  </div>

  <script type="text/babel">
    const baseRewards = {5: 250, 4: 100, 3: -500, 2: -2000};
    const SUBJECTS = [
      "–ê–ª–≥–µ–±—Ä–∞","–ë–∏–æ–ª–æ–≥–∏—è","–¢–µ–æ—Ä–∏—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏","–ì–µ–æ–≥—Ä–∞—Ñ–∏—è","–ì–µ–æ–º–µ—Ç—Ä–∏—è","–ò–∑–æ","–ê–Ω–≥–ª–∏–π—Å–∫–∏–π",
      "–ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞","–ò—Å—Ç–æ—Ä–∏—è","–õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞","–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–∞–∫—Ç–∏–∫—É–º","–ú—É–∑—ã–∫–∞","–ü—Ä–∞–∫—Ç–∏–∫—É–º –ø–æ —Ä—É—Å—Å–∫–æ–º—É",
      "–†—É—Å—Å–∫–∏–π —è–∑—ã–∫","–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è","–§–∏–∑–∏–∫–∞","–§–∏–∑–∫—É–ª—å—Ç—É—Ä–∞"
    ];

    const firebaseConfig = {
      apiKey: "AIzaSyBCHpZRZddZwDrK0xVXXReGuEbJvkq9lQU",
      authDomain: "dany-school-gamification.firebaseapp.com",
      projectId: "dany-school-gamification",
      storageBucket: "dany-school-gamification.firebasestorage.app",
      messagingSenderId: "727126449185",
      appId: "1:727126449185:web:d7c5cef17d98d57dead760",
      measurementId: "G-D6EYQVZ9D4"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    function App() {
      const [subjects] = React.useState(SUBJECTS);
      const [selectedSubject, setSelectedSubject] = React.useState(subjects[0]);
      const [grade, setGrade] = React.useState(5);
      const [balance, setBalance] = React.useState(0);
      const [history, setHistory] = React.useState([]);
      const [cashOutAmount, setCashOutAmount] = React.useState("");
      const [loaded, setLoaded] = React.useState(false);

      const [user, setUser] = React.useState(null);
      const [email, setEmail] = React.useState("");
      const [password, setPassword] = React.useState("");

      React.useEffect(() => {
        return firebase.auth().onAuthStateChanged(u => {
          setUser(u);
          if (!u) { setHistory([]); setBalance(0); setLoaded(false); }
        });
      }, []);

      React.useEffect(() => {
        if (!user) return;
        const unsub = db.collection("users").doc(user.uid).onSnapshot(doc => {
          if (doc.exists) {
            const data = doc.data();
            setHistory(Array.isArray(data.history)?data.history:[]);
            setBalance(typeof data.balance==="number"?data.balance:0);
          } else { setHistory([]); setBalance(0);}
          setLoaded(true);
        });
        return () => unsub();
      }, [user]);

      React.useEffect(() => {
        if (!loaded || !user) return;
        db.collection("users").doc(user.uid).set({ balance, history })
          .catch(err=>console.error(err));
      }, [balance, history, loaded, user]);

      const register = async () => { try { await firebase.auth().createUserWithEmailAndPassword(email,password);} catch(e){alert(e.message);} };
      const login = async () => { try { await firebase.auth().signInWithEmailAndPassword(email,password);} catch(e){alert(e.message);} };
      const logout = async () => { await firebase.auth().signOut(); };

      const addGrade = () => {
        const date = new Date().toLocaleDateString("ru-RU");
        let reward=baseRewards[grade]||0, bonus=1, bonusDesc="";
        const todayGrades = history.filter(h=>h.date===date);
        const todayFives = todayGrades.filter(h=>h.grade===5).length;
        if (grade===5 && todayFives===1){bonus=2;bonusDesc="–£–¥–≤–æ–µ–Ω–∏–µ –∑–∞ 2 –ø—è—Ç—ë—Ä–∫–∏ –∑–∞ –¥–µ–Ω—å";}
        if (grade===5 && todayFives===2){bonus=3;bonusDesc="–£—Ç—Ä–æ–µ–Ω–∏–µ –∑–∞ 3 –ø—è—Ç—ë—Ä–∫–∏ –∑–∞ –¥–µ–Ω—å";}
        const sameSubject=history.filter(h=>h.subject===selectedSubject);
        const lastTwo=sameSubject.slice(-2), lastGrades=lastTwo.map(e=>e.grade);
        if (grade===5){
          if (lastGrades.length>=2&&lastGrades[0]===5&&lastGrades[1]===5){bonus=3.5;bonusDesc="–•–µ—Ç-—Ç—Ä–∏–∫ 3 –ø—è—Ç—ë—Ä–∫–∏ –ø–æ–¥—Ä—è–¥";}
          else if (lastGrades.length>=1&&lastGrades[0]===5){bonus=2.5;bonusDesc="–ë–æ–Ω—É—Å 2.5 –∑–∞ 2 –ø—è—Ç—ë—Ä–∫–∏ –ø–æ–¥—Ä—è–¥";}
        }
        const total=reward*bonus;
        setBalance(balance+total);
        setHistory([{date,subject:selectedSubject,grade,reward:total,bonus:bonusDesc},...history]);
      };

      const deleteEntry = i => {
        const e=history[i];
        setBalance(balance - e.reward);
        const newH=[...history]; newH.splice(i,1);
        setHistory(newH);
      };

      const cashOut = () => {
        const amount=Number(cashOutAmount);
        if(!amount||amount<=0) return alert("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É");
        if(amount>balance) return alert("–°—É–º–º–∞ –±–æ–ª—å—à–µ –±–∞–ª–∞–Ω—Å–∞");
        if(window.confirm(`–í—ã–¥–∞—Ç—å ${amount} ‚ÇΩ –∏ —É–º–µ–Ω—å—à–∏—Ç—å –±–∞–ª–∞–Ω—Å?`)){
          const date=new Date().toLocaleDateString("ru-RU");
          setHistory([{date,subject:"üí∏ –í—ã–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤",grade:"‚Äî",reward:-amount,bonus:"–ß–∞—Å—Ç–∏—á–Ω—ã–π –≤—ã–≤–æ–¥"},...history]);
          setBalance(balance-amount); setCashOutAmount("");
        }
      };

      const exportCSV=()=>{
        if(!history||history.length===0){alert("–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞");return;}
        const header=["–î–∞—Ç–∞","–ü—Ä–µ–¥–º–µ—Ç","–û—Ü–µ–Ω–∫–∞","–ë–æ–Ω—É—Å","–°—É–º–º–∞"];
        const rows=history.map(h=>[h.date||"",h.subject||"",h.grade||"",h.bonus||"",h.reward||""]);
        const csv=[header,...rows].map(r=>r.map(i=>`"${String(i).replace(/"/g,'""')}"`).join(",")).join("\n");
        const blob=new Blob([csv],{type:"text/csv;charset=utf-8;"}),url=URL.createObjectURL(blob);
        const a=document.createElement("a");a.href=url;a.download=`history_${new Date().toLocaleDateString("ru-RU")}.csv`;
        document.body.appendChild(a);a.click();document.body.removeChild(a);
      };

      const importCSV=file=>{
        const r=new FileReader();
        r.onload=e=>{
          const t=e.target.result, lines=t.trim().split(/\r?\n/);
          if(lines.length<2)return alert("–§–∞–π–ª –ø—É—Å—Ç");
          const data=lines.slice(1).map(l=>{
            const p=l.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(x=>x.replace(/^"|"$/g,'').replace(/""/g,'"'));
            return{date:p[0],subject:p[1],grade:p[2],bonus:p[3],reward:Number(p[4])};
          });
          const total=data.reduce((s,x)=>s+(isFinite(x.reward)?x.reward:0),0);
          if(window.confirm("–ó–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –∏–∑ —Ñ–∞–π–ª–∞ –∏ –∑–∞–º–µ–Ω–∏—Ç—å —Ç–µ–∫—É—â—É—é?")){setHistory(data);setBalance(total);}
        };
        r.readAsText(file,'UTF-8');
      };

      React.useEffect(()=>{
        const b=document.getElementById('burgerBtn'),s=document.getElementById('sidebar'),
              c=document.getElementById('closeSidebar'),ex=document.getElementById('exportBtn'),
              imp=document.getElementById('importFile');
        const open=()=>s.classList.add('open'),closeFn=()=>s.classList.remove('open'),
              onEx=()=>exportCSV(),onImp=e=>{if(e.target.files[0])importCSV(e.target.files[0]);};
        b.addEventListener('click',open);c.addEventListener('click',closeFn);
        ex.addEventListener('click',onEx);imp.addEventListener('change',onImp);
        return()=>{b.removeEventListener('click',open);c.removeEventListener('click',closeFn);
          ex.removeEventListener('click',onEx);imp.removeEventListener('change',onImp);};
      },[history]);

      return (
        React.createElement("div",null,
          React.createElement("h1",null,"–£—á–µ–±–Ω–∞—è –≥–µ–π–º–∏—Ñ–∏–∫–∞—Ü–∏—è"),
          !user ?
            React.createElement(React.Fragment,null,
              React.createElement("div",{className:"auth"},
                React.createElement("input",{placeholder:"Email",value:email,onChange:e=>setEmail(e.target.value)}),
                React.createElement("input",{placeholder:"–ü–∞—Ä–æ–ª—å",type:"password",value:password,onChange:e=>setPassword(e.target.value)}),
                React.createElement("button",{onClick:login},"–í–æ–π—Ç–∏"),
                React.createElement("button",{onClick:register},"–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è")
              ),
              React.createElement("div",{className:"muted"},"–í–æ–π–¥–∏—Ç–µ –∏–ª–∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å, —á—Ç–æ–±—ã –≤–µ—Å—Ç–∏ –ª–∏—á–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é.")
            )
          :
            React.createElement("div",{className:"auth"},
              React.createElement("span",null,"–í—ã –≤–æ—à–ª–∏ –∫–∞–∫ ",React.createElement("b",null,user.email)),
              React.createElement("button",{onClick:logout},"–í—ã–π—Ç–∏")
            ),
          user &&
            React.createElement(React.Fragment,null,
              React.createElement("form",{onSubmit:e=>{e.preventDefault();addGrade();}},
                React.createElement("select",{value:selectedSubject,onChange:e=>setSelectedSubject(e.target.value)},
                  subjects.map(s=>React.createElement("option",{key:s},s))
                ),
                React.createElement("select",{value:grade,onChange:e=>setGrade(Number(e.target.value))},
                  [5,4,3,2].map(g=>React.createElement("option",{key:g,value:g},g))
                ),
                React.createElement("button",{type:"submit"},"–î–æ–±–∞–≤–∏—Ç—å")
              ),
              React.createElement("h2",null,"–ë–∞–ª–∞–Ω—Å: ",balance," ‚ÇΩ"),
              React.createElement("div",{className:"cashout-area"},
                React.createElement("input",{className:"cashout-input",type:"number",placeholder:"–°—É–º–º–∞ –≤—ã–≤–æ–¥–∞",value:cashOutAmount,onChange:e=>setCashOutAmount(e.target.value)}),
                React.createElement("button",{className:"cashout-btn",onClick:cashOut},"üí∏ –í—ã–≤–µ—Å—Ç–∏ –≤ –∫—ç—à")
              ),
              React.createElement("div",{className:"history"},
                React.createElement("h3",null,"–ò—Å—Ç–æ—Ä–∏—è"),
                history.length===0 && React.createElement("p",null,"–ü–æ–∫–∞ –Ω–µ—Ç –æ—Ü–µ–Ω–æ–∫."),
                history.map((h,i)=>
                  React.createElement("div",{key:i,className:"entry"},
                    React.createElement("div",null,
                      h.date," ‚Äî ",h.subject,": ",
                      React.createElement("strong",{className:h.reward>=0?"":"negative"},h.grade),
                      h.bonus && React.createElement("span",{className:"bonus"}," + ",h.bonus),
                      " ‚Üí ",h.reward>=0?`+${h.reward}`:`${h.reward}`,"‚ÇΩ"
                    ),
                    React.createElement("button",{className:"delete-btn",onClick:()=>deleteEntry(i),title:"–£–¥–∞–ª–∏—Ç—å"},"üóëÔ∏è")
                  )
                )
              )
            )
        )
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(React.createElement(App));
  </script>
</body>
</html>
