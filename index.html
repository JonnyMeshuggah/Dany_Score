<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–£—á–µ–±–Ω–∞—è –ì–µ–π–º–∏—Ñ–∏–∫–∞—Ü–∏—è</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore-compat.js"></script>

  <style>
    body { font-family: sans-serif; max-width: 700px; margin: 40px auto; padding: 0 10px; }
    h1 { text-align: center; }
    form { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 20px; }
    select, input, button { padding: 6px 8px; font-size: 16px; }
    button { cursor: pointer; }
    .history { margin-top: 20px; }
    .entry { border-bottom: 1px solid #ccc; padding: 8px 0; display: flex; justify-content: space-between; align-items: center;}
    .bonus { color: green; font-weight: bold; }
    .negative { color: red; }
    .delete-btn { background: none; border: none; color: red; font-size: 18px; cursor: pointer; }

    .cashout-area { display:flex; gap:8px; align-items:center; justify-content:center; margin: 20px 0;}
    .cashout-btn { padding:10px 20px; font-size:18px; background:#4caf50; color:white; border:none; border-radius:5px; }
    .cashout-input { width:120px; font-size:16px; padding:6px; }

    /* –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å */
    .sidebar {
      position: fixed;
      top: 0;
      left: 0;
      transform: translateX(-100%);
      width: 280px;
      height: 100%;
      background: #333;
      color: #fff;
      padding: 16px;
      box-sizing: border-box;
      transition: transform 0.3s ease;
      z-index: 1000;
      overflow-y: auto;
    }
    .sidebar.open { transform: translateX(0); }
    .sidebar h2 { color:#fff; font-size:18px; margin: 0 0 16px 0; }

    .panel-btn {
      display:block; width:100%;
      margin-bottom:10px; padding:10px 12px; font-size:16px;
      background: transparent; color: inherit;
      border: 1px solid rgba(255,255,255,0.25);
      border-radius:8px; text-align:left;
    }
    .file-input { display:none; }

    .burger {
      position: fixed; top:20px; left:20px;
      font-size:26px; background:none; border:none; color:#333; cursor:pointer; z-index:1100;
    }
    .close-btn {
      position:absolute; top:10px; right:10px;
      background:none; border:none; color:white; font-size:24px; cursor:pointer;
    }
  </style>
</head>
<body>
  <button class="burger" id="burgerBtn">‚ò∞</button>
  <div id="root"></div>

  <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
  <div id="sidebar" class="sidebar">
    <button class="close-btn" id="closeSidebar" title="–ó–∞–∫—Ä—ã—Ç—å">‚úñ</button>
    <h2>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ</h2>
    <button class="panel-btn" id="exportBtn">‚¨áÔ∏è –≠–∫—Å–ø–æ—Ä—Ç CSV</button>
    <label class="panel-btn" for="importFile">üì§ –ò–º–ø–æ—Ä—Ç CSV</label>
    <input type="file" accept=".csv" id="importFile" class="file-input">
  </div>

  <script type="text/babel">
    const baseRewards = {5: 250, 4: 100, 3: -500, 2: -2000};
    const SUBJECTS = [
      "–ê–ª–≥–µ–±—Ä–∞","–ë–∏–æ–ª–æ–≥–∏—è","–¢–µ–æ—Ä–∏—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏","–ì–µ–æ–≥—Ä–∞—Ñ–∏—è","–ì–µ–æ–º–µ—Ç—Ä–∏—è","–ò–∑–æ","–ê–Ω–≥–ª–∏–π—Å–∫–∏–π",
      "–ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞","–ò—Å—Ç–æ—Ä–∏—è","–õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞","–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–∞–∫—Ç–∏–∫—É–º","–ú—É–∑—ã–∫–∞","–ü—Ä–∞–∫—Ç–∏–∫—É–º –ø–æ —Ä—É—Å—Å–∫–æ–º—É",
      "–†—É—Å—Å–∫–∏–π —è–∑—ã–∫","–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è","–§–∏–∑–∏–∫–∞","–§–∏–∑–∫—É–ª—å—Ç—É—Ä–∞"
    ];

    // Firebase config (—Ç–≤–æ–∏ –∫–ª—é—á–∏)
    const firebaseConfig = {
      apiKey: "AIzaSyBCHpZRZddZwDrK0xVXXReGuEbJvkq9lQU",
      authDomain: "dany-school-gamification.firebaseapp.com",
      projectId: "dany-school-gamification",
      storageBucket: "dany-school-gamification.firebasestorage.app",
      messagingSenderId: "727126449185",
      appId: "1:727126449185:web:d7c5cef17d98d57dead760",
      measurementId: "G-D6EYQVZ9D4"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    function App() {
      const [subjects] = React.useState(SUBJECTS);
      const [selectedSubject, setSelectedSubject] = React.useState(subjects[0]);
      const [grade, setGrade] = React.useState(5);
      const [balance, setBalance] = React.useState(0);
      const [history, setHistory] = React.useState([]);
      const [cashOutAmount, setCashOutAmount] = React.useState("");

      // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Firebase
      React.useEffect(() => {
        db.collection("users").doc("default_user").get()
          .then(doc => {
            console.log("Firebase load:", doc.exists, doc.data());
            if (doc.exists) {
              const data = doc.data();
              if (data.history) setHistory(data.history);
              if (data.balance !== undefined) setBalance(data.balance);
            }
          })
          .catch(err => console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:", err));
      }, []);

      // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ Firebase
      React.useEffect(() => {
        db.collection("users").doc("default_user").set({
          balance: balance,
          history: history
        })
        .then(()=>console.log("Firebase save ok", {balance,history}))
        .catch(err=>console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:",err));
      }, [balance, history]);

      const addGrade = () => {
        const date = new Date().toLocaleDateString("ru-RU");
        let reward = baseRewards[grade] || 0;
        let bonus = 1;
        let bonusDesc = "";

        const todayGrades = history.filter(h => h.date === date);
        const todayFives = todayGrades.filter(h => h.grade === 5).length;
        if (grade === 5 && todayFives === 1) { bonus = 2; bonusDesc = "–£–¥–≤–æ–µ–Ω–∏–µ –∑–∞ 2 –ø—è—Ç—ë—Ä–∫–∏ –∑–∞ –¥–µ–Ω—å"; }
        if (grade === 5 && todayFives === 2) { bonus = 3; bonusDesc = "–£—Ç—Ä–æ–µ–Ω–∏–µ –∑–∞ 3 –ø—è—Ç—ë—Ä–∫–∏ –∑–∞ –¥–µ–Ω—å"; }

        const sameSubject = history.filter(h => h.subject === selectedSubject);
        const lastTwo = sameSubject.slice(-2);
        const lastGrades = lastTwo.map(e => e.grade);
        if (grade === 5) {
          if (lastGrades.length >= 2 && lastGrades[0] === 5 && lastGrades[1] === 5) {
            bonus = 3.5; bonusDesc = "–•–µ—Ç-—Ç—Ä–∏–∫ 3 –ø—è—Ç—ë—Ä–∫–∏ –ø–æ–¥—Ä—è–¥ –ø–æ –ø—Ä–µ–¥–º–µ—Ç—É";
          } else if (lastGrades.length >= 1 && lastGrades[0] === 5) {
            bonus = 2.5; bonusDesc = "–ë–æ–Ω—É—Å 2.5 –∑–∞ 2 –ø—è—Ç—ë—Ä–∫–∏ –ø–æ–¥—Ä—è–¥ –ø–æ –ø—Ä–µ–¥–º–µ—Ç—É";
          }
        }

        const total = reward * bonus;
        setBalance(balance + total);
        const newEntry = {date, subject: selectedSubject, grade, reward: total, bonus: bonusDesc};
        setHistory([newEntry, ...history]);
      };

      const deleteEntry = (index) => {
        const entry = history[index];
        setBalance(balance - entry.reward);
        const updated = [...history];
        updated.splice(index, 1);
        setHistory(updated);
      };

      const cashOut = () => {
        const amount = Number(cashOutAmount);
        if (!amount || amount <= 0) return alert("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É!");
        if (amount > balance) return alert("–°—É–º–º–∞ –±–æ–ª—å—à–µ –¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ –±–∞–ª–∞–Ω—Å–∞!");
        if (window.confirm(`–í—ã–¥–∞—Ç—å ${amount} ‚ÇΩ –∏ —É–º–µ–Ω—å—à–∏—Ç—å –±–∞–ª–∞–Ω—Å?`)) {
          const date = new Date().toLocaleDateString("ru-RU");
          const newEntry = {date, subject:"üí∏ –í—ã–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤", grade:"‚Äî", reward: -amount, bonus:"–ß–∞—Å—Ç–∏—á–Ω—ã–π –≤—ã–≤–æ–¥"};
          setHistory([newEntry, ...history]);
          setBalance(balance - amount);
          setCashOutAmount("");
        }
      };

      const exportCSV = () => {
        if(history.length === 0) return alert("–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞");
        const header = ["–î–∞—Ç–∞","–ü—Ä–µ–¥–º–µ—Ç","–û—Ü–µ–Ω–∫–∞","–ë–æ–Ω—É—Å","–°—É–º–º–∞"];
        const rows = history.map(h => [h.date, h.subject, h.grade, h.bonus || "", h.reward]);
        const csvContent = [header, ...rows]
          .map(row => row.map(item => `"${String(item).replace(/"/g, '""')}"`).join(","))
          .join("\n");
        const blob = new Blob([csvContent], {type: 'text/csv;charset=utf-8;'});
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.download = `history_${new Date().toLocaleDateString("ru-RU")}.csv`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      };

      const importCSV = (file) => {
        const reader = new FileReader();
        reader.onload = (evt) => {
          const text = evt.target.result;
          const lines = text.trim().split(/\r?\n/);
          if(lines.length < 2) return alert("–§–∞–π–ª –ø—É—Å—Ç–æ–π –∏–ª–∏ –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç");
          const data = lines.slice(1).map(line => {
            const parts = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(x => x.replace(/^"|"$/g,'').replace(/""/g,'"'));
            return {
              date: parts[0],
              subject: parts[1],
              grade: parts[2],
              bonus: parts[3],
              reward: Number(parts[4])
            };
          });
          const total = data.reduce((sum, x) => sum + x.reward, 0);
          if(window.confirm("–ó–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –∏–∑ —Ñ–∞–π–ª–∞ –∏ –∑–∞–º–µ–Ω–∏—Ç—å —Ç–µ–∫—É—â—É—é?")) {
            setHistory(data);
            setBalance(total);
          }
        };
        reader.readAsText(file, 'UTF-8');
      };

      React.useEffect(() => {
        const burger = document.getElementById('burgerBtn');
        const sidebar = document.getElementById('sidebar');
        const close = document.getElementById('closeSidebar');
        const exportBtn = document.getElementById('exportBtn');
        const importFile = document.getElementById('importFile');

        const open = () => sidebar.classList.add('open');
        const closeFn = () => sidebar.classList.remove('open');
        const onExport = () => exportCSV();
        const onImportChange = (e) => { if(e.target.files[0]) importCSV(e.target.files[0]); };

        burger.addEventListener('click', open);
        close.addEventListener('click', closeFn);
        exportBtn.addEventListener('click', onExport);
        importFile.addEventListener('change', onImportChange);

        return () => {
          burger.removeEventListener('click', open);
          close.removeEventListener('click', closeFn);
          exportBtn.removeEventListener('click', onExport);
          importFile.removeEventListener('change', onImportChange);
        };
      }, []);

      return (
        <div>
          <form onSubmit={e => {e.preventDefault(); addGrade();}}>
            <select value={selectedSubject} onChange={e => setSelectedSubject(e.target.value)}>
              {subjects.map(s => <option key={s}>{s}</option>)}
            </select>
            <select value={grade} onChange={e => setGrade(Number(e.target.value))}>
              {[5,4,3,2].map(g => <option key={g} value={g}>{g}</option>)}
            </select>
            <button type="submit">–î–æ–±–∞–≤–∏—Ç—å</button>
          </form>

          <h2>–ë–∞–ª–∞–Ω—Å: {balance} ‚ÇΩ</h2>
          <div className="cashout-area">
            <input className="cashout-input" type="number" placeholder="–°—É–º–º–∞ –≤—ã–≤–æ–¥–∞" value={cashOutAmount} onChange={e=>setCashOutAmount(e.target.value)} />
            <button className="cashout-btn" onClick={cashOut}>üí∏ –í—ã–≤–µ—Å—Ç–∏ –≤ –∫—ç—à</button>
          </div>

          <div className="history">
            <h3>–ò—Å—Ç–æ—Ä–∏—è</h3>
            {history.length === 0 && <p>–ü–æ–∫–∞ –Ω–µ—Ç –æ—Ü–µ–Ω–æ–∫.</p>}
            {history.map((h, i) => (
              <div key={i} className="entry">
                <div>
                  {h.date} ‚Äî {h.subject}: <strong className={h.reward>=0?"":"negative"}>{h.grade}</strong>
                  {h.bonus && <span className="bonus"> + {h.bonus}</span>}
                  ‚Üí {h.reward>=0?`+${h.reward}`:`${h.reward}`}‚ÇΩ
                </div>
                <button className="delete-btn" onClick={() => deleteEntry(i)} title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</button>
              </div>
            ))}
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>
